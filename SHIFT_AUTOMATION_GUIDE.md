# シフト自動化システム 完全ガイド

## 📋 概要

従業員個人のシフト希望を集約して、毎朝自動でSlackに投稿するシステムです。GAS（Google Apps Script）を使用して属人化を防ぎ、スケーラブルな運用が可能です。

## 🏗️ システム構成

```
従業員個人シート → マスター集約シート → GAS → Slack投稿
     ↓                    ↓
  シフト希望入力      承認済みシフト集約
```

## 📁 ファイル構成

### 作成されるファイル
- `employee_shift_template.py` - 従業員用テンプレート作成
- `master_aggregation_sheet.py` - マスターシート作成
- `gas_aggregation_script.js` - GASスクリプト
- `setup_shift_automation.py` - セットアップスクリプト

### 生成されるスプレッドシート
1. **マスター集約シート** - 全体の管理と集約
2. **従業員個人シート** - 各従業員のシフト希望入力

## 🚀 セットアップ手順

### 1. 事前準備

```bash
# 必要なライブラリをインストール
pip3 install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

# 認証ファイルを配置
# rapid-being-472521-a0-d01f438f34a9.json を同じディレクトリに配置
```

### 2. 完全自動セットアップ

```bash
python3 setup_shift_automation.py
```

選択肢から「1. 完全自動セットアップ」を選択すると、以下が自動実行されます：
- マスター集約シートの作成
- 従業員テンプレートの作成（5名分のサンプル）
- 設定ファイルの生成

### 3. 手動セットアップ（段階的）

#### ステップ1: マスターシート作成
```bash
python3 master_aggregation_sheet.py
```

#### ステップ2: 従業員テンプレート作成
```bash
python3 employee_shift_template.py
```

## 📊 従業員シートのフォーマット

### 必須列（全員共通）
| 列名 | 説明 | 例 |
|------|------|-----|
| employee_id | 従業員ID | EID-001 |
| employee_name | 従業員名 | 山田太郎 |
| store | 店舗 | 東京 |
| role | 役職 | 販売 |
| date | 日付 | 2025-11-01 |
| start_time | 開始時間 | 10:00 |
| end_time | 終了時間 | 19:00 |
| break_min | 休憩分 | 60 |
| shift_type | シフトタイプ | 通常 |
| notes | 備考 | 学校行事の都合で... |
| status | 承認ステータス | Pending/Approved/Rejected |
| manager | 承認者 | 佐藤 |
| approved_at | 承認日時 | 2025-10-25 14:05 |

### データ検証ルール
- **店舗**: 東京/大阪/名古屋 から選択
- **役職**: 販売/受付/事務 から選択
- **シフトタイプ**: 通常/早番/遅番/休 から選択
- **ステータス**: Pending/Approved/Rejected から選択
- **日付**: 未来日のみ入力可能

## ⚙️ GASスクリプトの設定

### 1. マスターシートにGASスクリプトを追加

1. マスターシートを開く
2. 「拡張機能」→「Apps Script」を選択
3. `gas_aggregation_script.js` の内容をコピー&ペースト
4. 保存

### 2. プロパティの設定

```javascript
// スクリプトプロパティに以下を設定
SLACK_WEBHOOK_URL = 'https://hooks.slack.com/services/YOUR_WEBHOOK_URL'
SLACK_CHANNEL = '#リモートチーム勤怠報告'
DRIVE_FOLDER_ID = 'YOUR_DRIVE_FOLDER_ID'  // 任意
```

### 3. 初回実行とテスト

```javascript
// 関数を選択して実行
testAggregation()
```

### 4. 自動化トリガーの設定

1. 「トリガー」→「トリガーを追加」
2. 設定：
   - 実行する関数: `aggregateShiftsAndPostToSlack`
   - イベントのソース: 時間主導型
   - 時刻: 毎日 午前9時（日本時間）

## 🔄 運用フロー

### 従業員側
1. 個人シートでシフト希望を入力
2. 締切日までに入力完了
3. マネージャーからの承認待ち

### マネージャー側
1. 各従業員のシフト希望を確認
2. 承認/却下を決定
2. `status`列を`Approved`に変更
3. `manager`と`approved_at`を記録

### システム側
1. 毎朝9時に自動実行
2. 全従業員シートから`Approved`のシフトを集約
3. CSVファイルをGoogleドライブに保存
4. Slackに投稿（リンク付き）

## 📱 Slack投稿例

```
🌅 おはようございます！
📅 2025-11-01(土)のシフト集約結果 📅

📊 合計 8件のシフトが承認されています

🏪 東京店
🕐 09:00-18:00: 山田太郎 (販売) - 通常
🕐 10:00-19:00: 鈴木次郎 (受付) - 通常

🏪 大阪店
🕐 10:30-19:30: 佐藤花子 (販売) - 通常

📁 詳細CSVファイル: https://drive.google.com/...

💪 今日も一日頑張りましょう！
```

## 🛠️ トラブルシューティング

### よくある問題

1. **認証エラー**
   - サービスアカウントキーファイルのパスを確認
   - 必要な権限（Sheets, Drive）が付与されているか確認

2. **Slack投稿が失敗**
   - Webhook URLが正しいか確認
   - チャンネル名が正しいか確認

3. **従業員シートが読み込めない**
   - スプレッドシートIDが正しいか確認
   - シート名が`request`になっているか確認
   - 共有権限が適切に設定されているか確認

### ログの確認

マスターシートの`logs`シートで実行ログを確認できます：
- 実行日時
- 処理結果
- エラー詳細
- 処理件数

## 🔧 カスタマイズ

### 通知時間の変更
```javascript
// トリガー設定で時刻を変更
// 例：午前8時 → 午前8時
```

### 投稿チャンネルの変更
```javascript
// プロパティでチャンネルを変更
SLACK_CHANNEL = '#your-channel'
```

### 店舗の追加
```python
# employee_shift_template.py の店舗リストを編集
store_validation = {
    'values': [
        {'userEnteredValue': '東京'}, 
        {'userEnteredValue': '大阪'}, 
        {'userEnteredValue': '名古屋'},
        {'userEnteredValue': '福岡'}  # 追加
    ]
}
```

## 📈 拡張機能

### 1. 店舗別CSVファイル生成
各店舗ごとに個別のCSVファイルを作成

### 2. メール通知
Slackに加えてメール通知も送信

### 3. シフト重複チェック
同じ時間帯に複数の人がシフトに入っていないかチェック

### 4. 勤務時間集計
月間の勤務時間を自動集計

## 🔒 セキュリティ考慮事項

1. **アクセス権限**
   - 従業員は自分のシートのみ編集可能
   - マネージャーは全シート閲覧・承認可能

2. **データ保護**
   - 個人情報は最小限に留める
   - 共有リンクの有効期限設定

3. **監査ログ**
   - すべての操作をログに記録
   - 定期的なログ確認

## 📞 サポート

システムに関する質問や問題が発生した場合は、以下を確認してください：

1. ログファイル（`logs`シート）
2. エラーメッセージ
3. 設定値（プロパティ）

---

**🎉 これで完全なシフト自動化システムが構築できました！**
