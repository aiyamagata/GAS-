# シフト自動化システム セットアップガイド

このガイドでは、シフト自動化システムを初心者でも簡単にセットアップできるよう、ステップバイステップで説明します。

## 📋 事前準備

### 必要なもの
- Googleアカウント
- Slackワークスペース
- 管理者権限（スプレッドシートとSlackの設定）

### 想定時間
- 初回セットアップ: 30-60分
- 従業員シート作成: 従業員数 × 5分

## 🚀 セットアップ手順

### ステップ1: Slack Webhook URLの作成

1. **SlackでIncoming Webhookを作成**
   - Slackの「App」→「Incoming Webhooks」を検索
   - 「Add New Webhook to Workspace」をクリック
   - 投稿先チャンネルを選択（例：`#リモートチーム勤怠報告`）
   - Webhook URLをコピー（`https://hooks.slack.com/services/...` の形式）

2. **Webhook URLをメモ**
   - 後でGASプロパティで使用します
   - 安全な場所に保存してください

### ステップ2: マスター集約シートの作成

1. **新しいGoogleスプレッドシートを作成**
   - Googleスプレッドシートを開く
   - 「空白のスプレッドシート」を選択
   - 名前を「シフト管理マスター」に変更

2. **3つのシートを作成**
   - シート名を`config`に変更
   - 新しいシートを追加して`aggregated_shifts`に変更
   - 新しいシートを追加して`logs`に変更

3. **`config`シートの列構成を設定**
   ```
   A列: employee_id
   B列: employee_name
   C列: spreadsheet_id
   D列: role
   E列: slack_webhook_url
   F列: notification_time
   G列: status
   H列: last_updated
   I列: notes
   ```

4. **サンプルデータを入力**
   ```
   EID-001	山田太郎	[後で設定]	販売	[Webhook URL]	10:00	Active	2025-10-23	マネージャー
   EID-002	佐藤花子	[後で設定]	受付	[Webhook URL]	10:00	Active	2025-10-23	マネージャー
   ```

### ステップ3: 従業員用シートの作成

1. **テンプレートシートを作成**
   - 新しいGoogleスプレッドシートを作成
   - 名前を「従業員シフト希望テンプレート」に変更
   - シート名を`request`に変更

2. **列構成を設定**
   ```
   A列: employee_id
   B列: employee_name
   C列: store
   D列: role
   E列: date
   F列: start_time
   G列: end_time
   H列: break_min
   I列: shift_type
   J列: work_content
   K列: notes
   L列: status
   M列: manager
   N列: approved_at
   ```

3. **データ検証ルールを設定**
   - **C列（store）**: データの入力規則 → リストを直接入力 → `東京,大阪,名古屋,在宅`
   - **D列（role）**: データの入力規則 → リストを直接入力 → `販売,受付,事務,管理,アルバイト`
   - **I列（shift_type）**: データの入力規則 → リストを直接入力 → `通常,早番,遅番,休み,特別勤務`
   - **L列（status）**: データの入力規則 → リストを直接入力 → `承認,確認中,非承認`

4. **条件付き書式を設定**
   - **土日の日付**: 薄いグレー背景
   - **承認行**: 緑色背景
   - **確認中行**: 黄色背景
   - **非承認行**: 赤色背景

5. **従業員分のシートを複製**
   - テンプレートシートを従業員数分複製
   - 各シートの名前を「[従業員名] シフト希望」に変更
   - 各シートのA列とB列に従業員情報を入力

### ステップ4: スプレッドシートIDの取得と登録

1. **各従業員シートのIDを取得**
   - 従業員用シートを開く
   - URLから`d/`と`/edit`の間の文字列をコピー
   - 例：`https://docs.google.com/spreadsheets/d/1AbcdefGhijk.../edit#gid=0`
   - `1AbcdefGhijk...`の部分がスプレッドシートID

2. **マスター集約シートの`config`シートを更新**
   - C列の`spreadsheet_id`に、コピーしたIDを貼り付け
   - E列の`slack_webhook_url`に、ステップ1で作成したWebhook URLを貼り付け

### ステップ5: GASスクリプトの配置

1. **マスター集約シートでGASを開く**
   - 「拡張機能」→「Apps Script」を選択
   - 新しいタブでGASエディタが開きます

2. **スクリプトを貼り付け**
   - 既存のコードをすべて削除
   - `gas_aggregation_script.js`の内容をコピー&ペースト
   - ファイル名を「Code.gs」に変更して保存

3. **プロパティを設定**
   - 左側メニューの「プロジェクトの設定」（歯車アイコン）をクリック
   - 「スクリプトプロパティ」セクションまでスクロール
   - 「スクリプトプロパティを追加」をクリック
   - 以下のプロパティを追加：
     ```
     キー: SLACK_WEBHOOK_URL
     値: [ステップ1で作成したWebhook URL]
     
     キー: SLACK_CHANNEL
     値: #リモートチーム勤怠報告
     
     キー: DRIVE_FOLDER_ID
     値: [任意] CSVファイルを保存したいフォルダのID
     ```

### ステップ6: テスト実行

1. **手動実行**
   - GASエディタで`aggregateShiftsAndPostToSlack`関数を選択
   - 実行ボタン（▶）をクリック
   - 初回実行時は権限承認が必要です

2. **動作確認**
   - Slackに投稿が来るか確認
   - `aggregated_shifts`シートにデータが集約されるか確認
   - `logs`シートに実行ログが記録されるか確認

### ステップ7: 自動化の設定

1. **トリガーを設定**
   - 左側メニューの「トリガー」（時計アイコン）をクリック
   - 「トリガーを追加」をクリック
   - 以下の設定：
     ```
     実行する関数を選択: aggregateShiftsAndPostToSlack
     イベントのソースを選択: 時間主導型
     時間ベースのトリガーのタイプを選択: 日付ベースのタイマー
     時刻を選択: 午前10時～11時
     ```
   - 「保存」をクリック

## 🔧 権限設定

### マスター集約シート
- **編集者**: マネージャー、システム管理者
- **閲覧者**: 全従業員

### 従業員個人シート
- **編集者**: 本人、マネージャー
- **閲覧者**: マネージャー

## 📊 テストデータの作成

### 従業員用シートにテストデータを入力

1. **シフト希望を入力**
   ```
   EID-001	山田太郎	東京	販売	2025-11-01	10:00	19:00	60	通常	レジ業務、商品陳列	学校行事の都合で...	確認中		
   ```

2. **マネージャーとして承認**
   ```
   EID-001	山田太郎	東京	販売	2025-11-01	10:00	19:00	60	通常	レジ業務、商品陳列	学校行事の都合で...	承認	佐藤	2025-10-25 14:05
   ```

### システムのテスト実行

1. **手動実行**
   - GASエディタで`aggregateShiftsAndPostToSlack`関数を実行

2. **結果確認**
   - Slackに投稿が来る
   - `aggregated_shifts`シートに「承認」のシフトのみが集約される
   - `logs`シートに実行ログが記録される

## 🚨 トラブルシューティング

### よくある問題と解決方法

1. **「Missing property: SLACK_WEBHOOK_URL」エラー**
   - GASプロパティで`SLACK_WEBHOOK_URL`が設定されているか確認
   - Webhook URLが正しい形式か確認

2. **「Slack API エラー: 404」**
   - Webhook URLが正しいか確認
   - SlackのIncoming Webhookが有効か確認

3. **「Sheet not found: request」エラー**
   - 従業員シートのシート名が`request`になっているか確認
   - スプレッドシートIDが正しいか確認

4. **「Permission denied」エラー**
   - 従業員シートの共有権限を確認
   - マスター集約シートの共有権限を確認

### ログの確認方法

1. **GASエディタの実行ログ**
   - 実行ボタンの下に表示されるログを確認

2. **マスター集約シートの`logs`シート**
   - 実行履歴とエラー詳細を確認

## ✅ セットアップ完了チェックリスト

- [ ] Slack Webhook URLが作成されている
- [ ] マスター集約シートが作成されている
- [ ] 従業員用シートが作成されている
- [ ] GASスクリプトが配置されている
- [ ] プロパティが設定されている
- [ ] テスト実行が成功している
- [ ] トリガーが設定されている
- [ ] 権限設定が完了している

## 🎉 セットアップ完了！

これで、シフト自動化システムのセットアップが完了しました。

### 次のステップ
1. 従業員にシフト希望入力の依頼
2. マネージャーによる承認作業
3. 翌日の10時に自動投稿されることを確認

### 運用開始
- 従業員は個人シートでシフト希望を入力
- マネージャーは承認/却下を決定
- システムが毎朝10時に自動でSlackに投稿

何か問題が発生した場合は、ログを確認してトラブルシューティングガイドを参照してください。
